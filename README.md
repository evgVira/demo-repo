# server-config

## Конфигурация RabbitMQ
В config-files/rabbit хранится конфигурация файлов.

docker-compose.yml - конфигурация для docker контейнера. Здесь прописаны <b>порты</b>, <b>плагины</b> и пути к <b>конфигам</b>.

rabbitmq.conf - файл конфигурации rabbitmq. В нем прописывается:

1. `management.load_definitions =` - путь к файлам, определяющим эксенджеры, очереди, биндинги и профиля пользователей.
2. `stream.advertised_host =` - адрес хоста при подключении через stream контейнер. Этот адрес rabbit отдает клиенту при попытке подключения к стриму, а потом клиент коннектится к этому адресу. Если его не задать в ручную, то rabbit отдает какие-то странные значения.
3. `stream.advertised_port =` - порт хоста при подключении через stream контейнер.

definitions - директория с конфигурациями очередей для каждого микросервиса.

## Конфигурация Spring Cloud Stream
`spring.rabbitmq` - параметры для подключения к брокеру. Если необходимо будет подключаться через контейнер типа `stream`, то необходимо еще прописать `spring.rabbitmq.stream`.

`spring.cloud.function` - функции, которые будут автоматически привязываться к прописанным биндингам. 
Консьюмеры привязываются в соответствии с шаблоном - `имя_функции-in-0`, продюсеры - `имя_функции-out-0`.

`spring.cloud.stream.rabbit` - секция, в которой прописываются параметры, специфичные для брокера rabbit.

`spring.cloud.stream.rabbit.default` - общие параметры для всех биндингов. 
В нашем случае здесь прописанные параметры, отвечающие за то, что клиент не будет пытаться сам создать эксенджеры 
и очереди, а будет использовать уже существующие.

`spring.cloud.stream.rabbit.bindings` - секция с параметрами для конкретных биндингов. 
Прописывается если имеем дело со специфичными очередями (например stream) и эксенджерами (например delayed).

С очередями типа stream можно работать через обычный контейнер, но тогда нельзя будет задавать offset очереди в ручную. 
Для использования всех возможностей очередей stream необходимо прописать `container-type: stream`, 
а на стороне rabbit подключить плагин `rabbitmq_stream`.

`spring.cloud.stream.bindings` - секция с объявлением самих биндингов. В качестве имя для `exchanges` 
использует поле `destination`, в качестве названия `queues` - `group`. 
Биндинги автоматически связываются с вышеописанными функциями. 
Механизм продюсеров работает таким образом, что клиент с определенным промежутком времени опрашивает привязанный 
функциональный интерфейс типа Supplier, который возвращает значение в очередь. 
В нашем случае такое не подходит, поэтому используется класс StreamBridge. В методе send он принимает название 
биндинга и само сообщение.